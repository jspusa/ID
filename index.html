<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>製成品品號申請單 (10碼)</title>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <style>
    :root {
      --primary-color: #4a90e2;
      --secondary-color: #f5f7fa;
      --border-radius: 8px;
      --padding: 12px;
      --font-family: 'Helvetica Neue', Arial, sans-serif;
    }
    * { box-sizing: border-box; }
    body {
      font-family: var(--font-family);
      background: var(--secondary-color);
      margin: 0;
      padding: var(--padding);
      color: #333;
    }
    h2 {
      margin-bottom: 16px;
      color: var(--primary-color);
      font-size: 1.5em;
      text-align: center;
    }
    form {
      max-width: 900px;
      margin: 0 auto;
      background: #fff;
      border-radius: var(--border-radius);
      padding: var(--padding);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    fieldset {
      border: 1px solid #ddd;
      border-radius: var(--border-radius);
      padding: var(--padding);
      margin-bottom: 20px;
    }
    legend {
      font-weight: bold;
      padding: 0 8px;
      color: var(--primary-color);
    }
    .form-group {
      display: flex;
      flex-wrap: wrap;
      margin-bottom: 12px;
      align-items: center;
    }
    .form-group label {
      flex: 1 1 200px;
      margin-right: 16px;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
    }
    .form-group input,
    .form-group select {
      padding: 8px;
      margin-top: 6px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 1em;
    }
    .form-group label.full-width {
      flex: 1 1 100%;
      margin-right: 0;
    }
    .inline-group {
      display: flex;
      align-items: center;
      gap: 24px;
      margin-top: 6px;
    }
    .inline-radio-group {
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 18px;
      margin-left: 0;
      margin-top: 0;
    }
    .inline-radio-group label {
      flex: unset;
      margin: 0;
      font-weight: normal;
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 4px;
    }
    button {
      background: var(--primary-color);
      color: #fff;
      border: none;
      border-radius: var(--border-radius);
      padding: 10px 20px;
      font-size: 1em;
      cursor: pointer;
      transition: background 0.3s;
      margin-right: 10px;
    }
    button:hover {
      background: #357abd;
    }
    .output {
      font-size: 1.4em;
      color: #b22222;
      font-weight: bold;
      text-align: center;
      margin-top: 16px;
      min-height: 2em;
    }
    .msg-tip {
      color: #27ae60;
      text-align: right;
      font-size: 0.95em;
      padding-right: 16px;
      margin-bottom: 0;
    }
    .msg-err {
      color: #e74c3c;
      font-size: 1em;
      text-align: center;
      margin-bottom: 0;
      font-weight: bold;
    }
    details {
      margin-bottom: 20px;
    }
    details summary {
      cursor: pointer;
      font-weight: bold;
      color: var(--primary-color);
      margin-bottom: 8px;
    }
  </style>
  <!-- Serial Generator Panel -->
  <style>
    #serialGen {
      position: fixed;
      bottom: var(--padding);
      right: var(--padding);
      width: auto;
      min-width: 140px;
      padding: 4px;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: var(--border-radius);
      box-shadow: none;
      transition: width 0.3s, padding 0.3s, box-shadow 0.3s;
      overflow: hidden;
      z-index: 1000;
    }
    #serialGen[open] {
      width: 340px;
      padding: var(--padding);
      box-shadow: 0 4px 20px rgba(0,0,0,0.12);
    }
    #serialGen summary {
      position: relative;
      display: block;
      text-align: right;
      padding-right: var(--padding);
      list-style: none;
    }
    #serialGen summary::-webkit-details-marker {
      display: none;
    }
    #serialGen summary::after {
      content: '▾';
      position: absolute;
      top: 50%;
      right: var(--padding);
      transform: translateY(-50%);
      font-size: 0.8em;
    }
    #serialGen[open] summary::after { content: '▴'; }
    .serial-section { margin-top: 12px; }
    .serial-row {
      display: flex;
      gap: 8px;
      margin-top: 6px;
    }
    #exportBtn {
      background: #27ae60;
      margin-right: 0;
    }
    #exportBtn:hover { background: #219150; }
    /* 自營/經銷對齊（整行） */
    .form-group.direct-group {
      display: grid;
      grid-template-columns: 90px 1fr 180px;
      align-items: center;
      gap: 6px 18px;
    }
    .form-group.direct-group > div {
      grid-column: 1;
      font-weight: bold;
      padding-top: 6px;
    }
    .form-group.direct-group .inline-radio-group {
      grid-column: 2;
    }
    .form-group.direct-group label[for="dealerCode"] {
      grid-column: 3;
      margin-top: 0;
      min-width: 160px;
    }
    @media (max-width: 700px) {
      #serialGen[open] { width: 98vw; left: 0; right: 0;}
      form { max-width: 99vw; }
      .form-group.direct-group { grid-template-columns: 1fr; }
      .form-group label { min-width: unset; }
    }
  </style>
</head>
<body>
  <!-- 流水號產生器（右下角浮動） -->
  <details id="serialGen">
    <summary>流水號產生器</summary>
    <div class="form-group">
      <label>品類
        <select id="serialCategory">
          <option value="">-- 請選擇 --</option>
          <option value="feed">飼料</option>
          <option value="tendon">火雞筋、巴沙魚皮</option>
          <option value="snack">一般零食(CR之外)、潔牙骨、漢方大補帖</option>
          <option value="kcdog">KCDOG 潔牙骨</option>
          <option value="canned">罐頭</option>
        </select>
      </label>
    </div>
    <div id="feedSection" class="serial-section" style="display:none;">
      <div class="form-group">
        <label>肉源 / 機能 (前兩碼)
          <select id="feedPrefix"></select>
        </label>
      </div>
      <div class="form-group">
        <label>規格 (最後一碼)
          <select id="feedSpec"></select>
        </label>
      </div>
    </div>
    <div id="tendonSection" class="serial-section" style="display:none;">
      <div class="form-group">
        <label>大小 (前兩碼)
          <select id="tendonSize"></select>
        </label>
      </div>
      <div class="form-group">
        <label>包裝 (最後一碼)
          <select id="tendonPack"></select>
        </label>
      </div>
    </div>
    <div id="snackSection" class="serial-section" style="display:none;">
      <div class="form-group">
        <label>流水號 (前兩碼)
          <select id="snackPrefix"></select>
        </label>
      </div>
      <div class="form-group">
        <label>重量 (最後一碼)
          <select id="snackWeight"></select>
        </label>
      </div>
    </div>
    <div id="kcdogSection" class="serial-section" style="display:none;">
      <div class="form-group">
        <label>流水號 (前兩碼)
          <select id="kcdogPrefix"></select>
        </label>
      </div>
      <div class="form-group">
        <label>重量 (最後一碼)
          <select id="kcdogWeight"></select>
        </label>
      </div>
    </div>
    <div id="cannedSection" class="serial-section" style="display:none;">
      <div class="form-group">
        <label>暫定流水號 (3 碼)
          <input type="text" id="cannedSerial" maxlength="3" pattern="\d{1,3}" placeholder="例如：001">
        </label>
      </div>
    </div>
    <button type="button" id="applySerialBtn">套用至表單</button>
    <div class="msg-tip" id="serialTip"></div>
  </details>

  <h2>製成品品號申請單 (10碼)</h2>
  <form id="productForm" autocomplete="off">
    <fieldset>
      <legend>品項類型</legend>
      <div class="form-group">
        <div class="inline-radio-group">
          <label><input type="radio" name="productType" value="finished" checked> 製成品</label>
          <label><input type="radio" name="productType" value="outsourced"> 委外加工成品</label>
        </div>
      </div>
    </fieldset>

    <fieldset>
      <legend>基本資料</legend>
      <div class="form-group">
        <label class="full-width">品名
          <input type="text" id="productName" placeholder="輸入品名" required>
        </label>
      </div>
      <div class="form-group">
        <label>規格
          <input type="text" id="spec" placeholder="例如：85g/包" required>
        </label>
        <label>品類
          <select id="category">
            <option value="1">1 乾糧</option>
            <option value="2">2 零食</option>
            <option value="3">3 罐頭</option>
            <option value="4">4 餐包</option>
            <option value="5">5 潔牙骨</option>
          </select>
        </label>
        <label>單位
          <select id="unit"></select>
        </label>
        <label id="unitCustomWrap" style="display:none;">
          自訂單位
          <input type="text" id="unitCustom" placeholder="輸入單位">
        </label>
      </div>
    </fieldset>

    <fieldset>
      <legend>產生品號必備</legend>
      <div class="form-group">
        <label>品牌
          <select id="brandSelect">
            <option value="A">A 艾富鮮</option>
            <option value="C">C 貓戀人</option>
            <option value="G">G 活力零食</option>
            <option value="H">H 赫緻</option>
            <option value="K">K 開心狗</option>
            <option value="M">M 關健時刻</option>
            <option value="R">R 紅布朗</option>
            <option value="V">V 每朝元氣</option>
          </select>
        </label>
        <label>系列
          <select id="seriesSelect"></select>
        </label>
        <label id="seriesCustomWrap" style="display:none;">
          自訂系列 (2碼)
          <input type="text" id="seriesCustom" maxlength="2" placeholder="例如：PR">
        </label>
      </div>
      <div class="form-group">
        <label>寵物
          <select id="petSelect">
            <option value="D">D 犬</option>
            <option value="C">C 貓</option>
            <option value="O">O 其他</option>
          </select>
        </label>
        <label>流水號 (3碼)
          <input type="text" id="serial" maxlength="3" pattern="[0-9]{1,3}" value="001">
        </label>
        <label id="languageWrap" style="display:none;">
          販售國家語言
          <select id="languageSelect">
            <option value="T">T 台灣</option>
            <option value="A">A 美國</option>
            <option value="J">J 日本</option>
            <option value="K">K 韓國</option>
            <option value="V">V 越南</option>
            <option value="L">L 泰國</option>
            <option value="C">C 中國</option>
            <option value="S">S 新加坡</option>
            <option value="H">H 香港</option>
            <option value="D">D 澳門</option>
            <option value="M">M 馬來西亞</option>
            <option value="I">I 印尼</option>
            <option value="O">O 印度</option>
            <option value="G">G 德國</option>
            <option value="F">F 法國</option>
            <option value="E">E 英國</option>
            <option value="U">U 歐盟</option>
            <option value="B">B 柬埔寨</option>
          </select>
        </label>
        <label id="manufactureWrap" style="display:none;">
          製造廠國家
          <select id="manufactureSelect">
            <option value="T">T 台灣</option>
            <option value="A">A 美國</option>
            <option value="J">J 日本</option>
            <option value="K">K 韓國</option>
            <option value="V">V 越南</option>
            <option value="L">L 泰國</option>
            <option value="C">C 中國</option>
            <option value="S">S 新加坡</option>
            <option value="H">H 香港</option>
            <option value="D">D 澳門</option>
            <option value="M">M 馬來西亞</option>
            <option value="I">I 印尼</option>
            <option value="O">O 印度</option>
            <option value="G">G 德國</option>
            <option value="F">F 法國</option>
            <option value="E">E 英國</option>
            <option value="U">U 歐盟</option>
            <option value="B">B 柬埔寨</option>
          </select>
        </label>
        <label id="countryWrap">主銷國家
          <select id="countrySelect">
            <option value="T">T 台灣</option>
            <option value="A">A 美國</option>
            <option value="J">J 日本</option>
            <option value="K">K 韓國</option>
            <option value="V">V 越南</option>
            <option value="L">L 泰國</option>
            <option value="C">C 中國</option>
            <option value="S">S 新加坡</option>
            <option value="H">H 香港</option>
            <option value="D">D 澳門</option>
            <option value="M">M 馬來西亞</option>
            <option value="I">I 印尼</option>
            <option value="O">O 印度</option>
            <option value="G">G 德國</option>
            <option value="F">F 法國</option>
            <option value="E">E 英國</option>
            <option value="U">U 歐盟</option>
          </select>
        </label>
      </div>
      <!-- 自營/經銷排列優化 -->
      <div class="form-group direct-group" id="directGroup">
        <div>自營 / 經銷</div>
        <div class="inline-radio-group">
          <label><input type="radio" name="direct" value="0" checked> 直營</label>
          <label><input type="radio" name="direct" value="1"> 經銷商</label>
        </div>
        <label for="dealerCode" id="dealerWrap" style="display:none;">
          經銷商編號
          <select id="dealerCode">
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
            <option value="6">6</option>
            <option value="7">7</option>
            <option value="8">8</option>
            <option value="9">9</option>
          </select>
        </label>
      </div>
    </fieldset>

    <details>
      <summary>ERP 必填區 (點擊展開)</summary>
      <div class="form-group">
        <label>會計 / 分類<input type="text" id="accountingClass" disabled></label>
        <label>主要庫別<input type="text" value="A01 製成品倉" disabled></label>
      </div>
      <div class="form-group">
        <label>營收分類 / 品類<input type="text" id="bankCategory" disabled></label>
        <label>銷售單位<input type="text" id="salesUnit" disabled></label>
      </div>
      <div class="form-group">
        <label>庫存管理<input type="checkbox" checked disabled></label>
        <label>批號管理<input type="radio" checked disabled> 需要</label>
      </div>
      <div class="form-group">
        <label>有效天數<input type="number" id="shelfLife" disabled></label>
        <label>複檢天數<input type="number" id="recheckDays" disabled></label>
      </div>
      <div class="form-group">
        <label>品號屬性<input type="text" value="M 製成品倉" disabled></label>
        <label>低階碼<input type="number" value="99" disabled></label>
        <label>補貨政策<input type="text" value="L" disabled></label>
        <label>領料碼<input type="number" value="1" disabled></label>
      </div>
    </details>

    <details>
      <summary>ERP 後補區 (點擊展開)</summary>
      <div class="form-group">
        <label>條碼<input type="text" id="barcode"></label>
        <label>產品定價<input type="number" id="price" step="0.01"></label>
      </div>
    </details>

    <div style="text-align:center; margin:20px 0;">
      <button type="button" id="generateBtn">產生品號</button>
      <button type="button" id="exportBtn">導出Excel</button>
    </div>
    <div id="errorMsg" class="msg-err"></div>
    <p class="output">品號：<span id="itemCode">--</span></p>
  </form>

  <script>
  (function(){
    // 靜態對照表
    const categoryUnits = {
      '1': ['包', '其他'],
      '2': ['包', '袋', '盒', '其他'],
      '3': ['盒', '其他'],
      '4': ['包', '其他'],
      '5': ['包', '其他']
    };
    const shelfLifeMap  = {'1':540,'2':720,'3':1080,'4':1080,'5':720};
    const recheckMap    = {'1':360,'2':540,'3':720,'4':720,'5':540};
    const defaultSeries = [{code:'PR',label:'PR'}];
    const seriesMap = {
      'A': [
        {code:'WD', label:'WIN無穀鮮肉糧'},
        {code:'OS', label:'鴕鳥優多'},
        {code:'AL', label:'鱷魚優多'},
        {code:'MC', label:'蒸肉罐'},
        {code:'SC', label:'蒸湯罐'},
        {code:'PC', label:'益菌罐'},
        {code:'HC', label:'H2O機能補水泥罐'},
        {code:'JD', label:'小春日和乾糧'},
        {code:'JC', label:'小春日和罐罐'},
        {code:'JT', label:'小春日和零食'},
        {code:'TS', label:'火雞筋條'},
        {code:'TR', label:'火雞筋甜甜圈'},
        {code:'TB', label:'火雞筋骨'},
        {code:'TZ', label:'火雞筋蝴蝶餅'},
        {code:'TP', label:'火雞筋八字結'},
        {code:'TA', label:'火雞筋麻花辮'},
        {code:'TO', label:'火雞筋卷'},
        {code:'TC', label:'火雞筋帶肉嚼片'},
        {code:'TT', label:'火雞肉零食'},
        {code:'DS', label:'火雞筋雞肉條'},
        {code:'DR', label:'火雞筋雞肉甜甜圈'},
        {code:'DB', label:'火雞筋雞肉骨'},
        {code:'RB', label:'小牛肋骨'},
        {code:'RT', label:'小牛肋骨與火雞筋'},
        {code:'CT', label:'雞肉零食'},
        {code:'BR', label:'(水)牛肉零食'},
        {code:'SL', label:'鮭魚零食'},
        {code:'SD', label:'鮭魚潔牙骨'},
        {code:'XX', label:'一次性產品'}
      ],
      'C': [
        {code:'MD', label:'低溫風乾糧'},
        {code:'MC', label:'朕是喵罐頭'},
        {code:'MT', label:'卵磷脂肉條'},
        {code:'XX', label:'一次性產品'}
      ],
      'G': [
        {code:'CR', label:'雞肉系列'},
        {code:'SL', label:'鮭魚零食系列'},
        {code:'SD', label:'鮭魚潔牙骨系列'},
        {code:'CT', label:'台灣製系列'},
        {code:'KR', label:'火雞筋系列'},
        {code:'MR', label:'小包裝系列'},
        {code:'YR', label:'YR'},
        {code:'BR', label:'(水)牛肉零食'},
        {code:'SR', label:'GS系列'},
        {code:'QR', label:'軟系列'},
        {code:'RB', label:'小牛肋條'},
        {code:'LR', label:'量販包'},
        {code:'TS', label:'火雞筋條'},
        {code:'TR', label:'火雞筋甜甜圈'},
        {code:'TB', label:'火雞筋骨'},
        {code:'TZ', label:'火雞筋蝴蝶餅'},
        {code:'TP', label:'火雞筋八字結'},
        {code:'TA', label:'火雞筋麻花辮'},
        {code:'TO', label:'火雞筋卷'},
        {code:'TC', label:'火雞筋帶肉嚼片'},
        {code:'TT', label:'火雞肉零食'},
        {code:'XX', label:'一次性產品'}
      ],
      'H': [
        {code:'SP', label:'單一純肉系列'},
        {code:'CL', label:'經典饗宴系列'},
        {code:'PR', label:'美饌系列'},
        {code:'ZS', label:'佐餐粉'},
        {code:'MC', label:'純肉餐罐'},
        {code:'HC', label:'滋補養生餐罐'},
        {code:'DR', label:'火雞筋雞肉甜甜圈'},
        {code:'DS', label:'火雞筋雞肉條'},
        {code:'DB', label:'火雞筋雞肉骨'},
        {code:'DP', label:'火雞筋雞肉八字'},
        {code:'DA', label:'火雞筋雞肉麻花'},
        {code:'XX', label:'一次性產品'}
      ],
      'K': [
        {code:'MD', label:'低溫風乾糧'},
        {code:'MC', label:'肉肉罐'},
        {code:'DT', label:'潔牙骨(專業通路)'},
        {code:'DF', label:'功能潔牙骨'},
        {code:'DC', label:'潔牙骨(人通)'},
        {code:'DQ', label:'軟Q潔牙骨'},
        {code:'CL', label:'零食系列KCL'},
        {code:'XX', label:'一次性產品'}
      ],
      'M': [
        {code:'HD', label:'機能健康糧'},
        {code:'PD', label:'益生健康糧'},
        {code:'HC', label:'保健餐罐'},
        {code:'HT', label:'機能雞肉條'},
        {code:'HS', label:'保健嚼棒'},
        {code:'ZD', label:'漢方健康糧'},
        {code:'ZC', label:'漢方主食罐'},
        {code:'ZT', label:'漢方養生大補帖'},
        {code:'ZS', label:'保健嚼棒'},
        {code:'XX', label:'一次性產品'}
      ],
      'R': [
        {code:'MD', label:'乾糧'},
        {code:'MT', label:'滿分零食'},
        {code:'XX', label:'一次性產品'}
      ],
      'V': [
        {code:'VD', label:'每朝活力小'},
        {code:'MD', label:'每朝活力大'},
        {code:'TS', label:'火雞筋條'},
        {code:'TR', label:'火雞筋甜甜圈'},
        {code:'TB', label:'火雞筋骨'},
        {code:'TZ', label:'火雞筋蝴蝶餅'},
        {code:'TP', label:'火雞筋八字結'},
        {code:'TA', label:'火雞筋麻花辮'},
        {code:'CR', label:'零食'},
        {code:'CC', label:'罐頭'},
        {code:'FT', label:'巴沙魚皮零食'},
        {code:'FS', label:'巴沙魚皮捲棒'},
        {code:'FR', label:'巴沙魚皮甜甜圈'},
        {code:'FB', label:'巴沙魚皮打結骨'},
        {code:'FA', label:'巴沙魚皮麻花辮'},
        {code:'DF', label:'機能潔牙棒'},
        {code:'XX', label:'一次性產品'}
      ]
    };
    const feedPrefixes = [
      { val: '01', text: '01 火雞' },
      { val: '02', text: '02 羊' },
      { val: '03', text: '03 鴨' },
      { val: '04', text: '04 牛' },
      { val: '05', text: '05 鹿' },
      { val: '06', text: '06 雞' },
      { val: '07', text: '07 魚' },
      { val: '08', text: '08 豬' },
      { val: '09', text: '09 鳥' },
      { val: '10', text: '10 蛋類' }
    ];
    const feedSpecs = [
      { val: '0', text: '0 1-99g' },
      { val: '1', text: '1 100-300g' },
      { val: '3', text: '3 301-500g' },
      { val: '5', text: '5 501-1000g' },
      { val: '7', text: '7 1001-2500g' },
      { val: '9', text: '9 2501g以上' }
    ];
    const tendonSizes = [
      { val: '01', text: '01 小' },
      { val: '03', text: '03 中' },
      { val: '05', text: '05 大' }
    ];
    const tendonPacks = [
      { val: '0', text: '0 盒裝小包' },
      { val: '1', text: '1 TTS05背封袋 105×290' },
      { val: '3', text: '3 ATS01吊掛袋 120×330' },
      { val: '5', text: '5 水牛零食中袋 190×250' },
      { val: '6', text: '6 AFK袋 180×280' },
      { val: '7', text: '7 GL量販袋 260×320' },
      { val: '9', text: '9 盒裝' }
    ];
    const snackPrefixes = Array.from({length:9},(_,i)=>({ val: pad(i+1,2), text: pad(i+1,2) }));
    const snackWeights = [
      { val: '0', text: '0 1-49g' },
      { val: '1', text: '1 50-224g' },
      { val: '3', text: '3 225-453g' },
      { val: '5', text: '5 454-681g' },
      { val: '7', text: '7 682-1362g' },
      { val: '9', text: '9 >1362g' }
    ];
    const kcdogPrefixes = Array.from({length:9},(_,i)=>({ val: pad(i+1,2), text: pad(i+1,2) }));
    const kcdogWeights = [
      { val: '0', text: '0 1-90g' },
      { val: '1', text: '1 91-224g' },
      { val: '3', text: '3 225-453g' },
      { val: '5', text: '5 454-681g' },
      { val: '7', text: '7 682-1362g' },
      { val: '9', text: '9 >1362g' }
    ];

    // DOM 元件
    const productTypeRadios = document.querySelectorAll('input[name="productType"]');
    const accountClassInput = document.getElementById('accountingClass');
    const catSel = document.getElementById('category');
    const unitSel = document.getElementById('unit');
    const unitCustomWrap = document.getElementById('unitCustomWrap');
    const unitCustomInput = document.getElementById('unitCustom');

    const bankCatInput = document.getElementById('bankCategory');
    const salesUnitInput = document.getElementById('salesUnit');
    const shelfLifeInput = document.getElementById('shelfLife');
    const recheckInput = document.getElementById('recheckDays');

    const brandSel = document.getElementById('brandSelect');
    const seriesSel = document.getElementById('seriesSelect');
    const seriesCustomWrap = document.getElementById('seriesCustomWrap');
    const seriesCustomInput = document.getElementById('seriesCustom');

    const petSel = document.getElementById('petSelect');
    const countryWrap = document.getElementById('countryWrap');
    const countrySel = document.getElementById('countrySelect');
    const languageWrap = document.getElementById('languageWrap');
    const languageSel = document.getElementById('languageSelect');
    const manufactureWrap = document.getElementById('manufactureWrap');
    const manufactureSel = document.getElementById('manufactureSelect');

    const dealerWrap = document.getElementById('dealerWrap');
    const dealerCode = document.getElementById('dealerCode');
    const directGroup = document.getElementById('directGroup');

    const serialInput = document.getElementById('serial');
    const itemCodeSpan = document.getElementById('itemCode');

    const serialCatSel = document.getElementById('serialCategory');
    const feedSection = document.getElementById('feedSection');
    const tendonSection = document.getElementById('tendonSection');
    const snackSection = document.getElementById('snackSection');
    const kcdogSection = document.getElementById('kcdogSection');
    const cannedSection = document.getElementById('cannedSection');

    const feedPrefix = document.getElementById('feedPrefix');
    const feedSpec = document.getElementById('feedSpec');
    const tendonSize = document.getElementById('tendonSize');
    const tendonPack = document.getElementById('tendonPack');
    const snackPrefix = document.getElementById('snackPrefix');
    const snackWeight = document.getElementById('snackWeight');
    const kcdogPrefix = document.getElementById('kcdogPrefix');
    const kcdogWeight = document.getElementById('kcdogWeight');
    const cannedSerial = document.getElementById('cannedSerial');

    function pad(num,len){ return String(num).padStart(len,'0'); }

    function updateAccountingClass(){
      const selected = document.querySelector('input[name="productType"]:checked');
      if(!selected) return;
      accountClassInput.value = selected.value === 'outsourced'
        ? '7 (500委外加工成品)'
        : '1 (300製成品)';
    }

    function handleProductTypeChange(){
      updateAccountingClass();
      const selected = document.querySelector('input[name="productType"]:checked');
      if(!selected) return;
      const isOutsourced = selected.value === 'outsourced';
      if(directGroup){
        directGroup.style.display = isOutsourced ? 'none' : 'grid';
      }
      if(isOutsourced){
        dealerWrap.style.display = 'none';
      } else {
        const directSelected = document.querySelector('input[name="direct"]:checked');
        dealerWrap.style.display = directSelected && directSelected.value === '1' ? 'flex' : 'none';
      }
      if(languageWrap){
        languageWrap.style.display = isOutsourced ? 'flex' : 'none';
      }
      if(manufactureWrap){
        manufactureWrap.style.display = isOutsourced ? 'flex' : 'none';
      }
      if(countryWrap){
        countryWrap.style.display = isOutsourced ? 'none' : 'flex';
      }
    }

    function populateUnits(){
      const units = categoryUnits[catSel.value] || [];
      unitSel.innerHTML = units.map(u=>`<option>${u}</option>`).join('');
      bankCatInput.value = catSel.value + ' ' + catSel.options[catSel.selectedIndex].text.slice(2);
      shelfLifeInput.value = shelfLifeMap[catSel.value] || '';
      recheckInput.value = recheckMap[catSel.value] || '';
      salesUnitInput.value = unitSel.value;
    }
    function handleUnitChange(){
      if(unitSel.value==='其他'){
        unitCustomWrap.style.display='flex'; salesUnitInput.value = unitCustomInput.value;
      } else {
        unitCustomWrap.style.display='none'; salesUnitInput.value = unitSel.value;
      }
    }
    function refreshSeries(){
      const list = seriesMap[brandSel.value] || defaultSeries;
      seriesSel.innerHTML = list.map(o=>`<option value="${o.code}">${o.label}（${o.code}）</option>`) + '<option value="custom">手動輸入</option>';
      seriesCustomWrap.style.display='none';
    }
    function initSerial(){
      if(feedPrefix) feedPrefix.innerHTML = feedPrefixes.map(o=>`<option value="${o.val}">${o.text}</option>`).join('');
      if(feedSpec) feedSpec.innerHTML = feedSpecs.map(o=>`<option value="${o.val}">${o.text}</option>`).join('');
      if(tendonSize) tendonSize.innerHTML = tendonSizes.map(o=>`<option value="${o.val}">${o.text}</option>`).join('');
      if(tendonPack) tendonPack.innerHTML = tendonPacks.map(o=>`<option value="${o.val}">${o.text}</option>`).join('');
      if(snackPrefix) snackPrefix.innerHTML = snackPrefixes.map(o=>`<option value="${o.val}">${o.text}</option>`).join('');
      if(snackWeight) snackWeight.innerHTML = snackWeights.map(o=>`<option value="${o.val}">${o.text}</option>`).join('');
      if(kcdogPrefix) kcdogPrefix.innerHTML = kcdogPrefixes.map(o=>`<option value="${o.val}">${o.text}</option>`).join('');
      if(kcdogWeight) kcdogWeight.innerHTML = kcdogWeights.map(o=>`<option value="${o.val}">${o.text}</option>`).join('');
    }
    function sanitizeCanned(){
      if(!cannedSerial) return '';
      const digits = (cannedSerial.value || '').replace(/\D/g,'');
      if(cannedSerial.value !== digits) cannedSerial.value = digits;
      return digits;
    }
    function updateSerialValue(){
      let val = '000';
      switch(serialCatSel.value){
        case 'feed':
          val = (feedPrefix?.value || '').slice(-2) + (feedSpec?.value || '');
          break;
        case 'tendon':
          val = (tendonSize?.value || '').slice(-2) + (tendonPack?.value || '');
          break;
        case 'snack':
          val = (snackPrefix?.value || '').slice(-2) + (snackWeight?.value || '');
          break;
        case 'kcdog':
          val = (kcdogPrefix?.value || '').slice(-2) + (kcdogWeight?.value || '');
          break;
        case 'canned':
          val = sanitizeCanned();
          break;
        default:
          val = serialInput.value || '000';
      }
      serialInput.value = pad(val || '0',3);
    }
    function generateCode(){
      errorMsg.textContent = "";
      const ser = seriesSel.value==='custom'?seriesCustomInput.value.toUpperCase():seriesSel.value;
      if(ser.length!==2){
        errorMsg.textContent = "系列須為2碼";
        itemCodeSpan.textContent = "--";
        return;
      }
      let serialVal = pad(serialInput.value,3);
      if(!/^\d{3}$/.test(serialVal)){
        errorMsg.textContent = "流水號須為3碼數字";
        itemCodeSpan.textContent = "--";
        return;
      }
      const productType = document.querySelector('input[name="productType"]:checked');
      const typeValue = productType ? productType.value : 'finished';
      const prefix = typeValue === 'outsourced' ? '7' : '1';
      let code = prefix + brandSel.value;
      code += ser + petSel.value + serialVal;
      if(typeValue === 'outsourced'){
        code += languageSel.value + manufactureSel.value;
      } else {
        const directSelected = document.querySelector('input[name="direct"]:checked');
        const dealerVal = directSelected && directSelected.value === '1' ? dealerCode.value : '0';
        code += countrySel.value + dealerVal;
      }
      itemCodeSpan.textContent = code;
    }
    // 導出Excel＋美化
    function exportToExcel(){
      generateCode();
      if(errorMsg.textContent){
        alert("請先修正錯誤再匯出！");
        return;
      }
      const productType = document.querySelector('input[name="productType"]:checked');
      const typeValue = productType ? productType.value : 'finished';
      const isOutsourced = typeValue === 'outsourced';
      const directSelected = document.querySelector('input[name="direct"]:checked');
      const directValue = directSelected ? directSelected.value : '0';
      const dealerVal = !isOutsourced && directValue === '1' ? dealerCode.value : '0';
      const directText = isOutsourced ? '委外加工' : (directValue === '0' ? '直營' : '經銷');
      const languageText = isOutsourced ? languageSel.options[languageSel.selectedIndex].text : '';
      const manufactureText = isOutsourced ? manufactureSel.options[manufactureSel.selectedIndex].text : '';
      const countryText = countrySel.options[countrySel.selectedIndex].text;

      const data = [
        ["基本資料", ""],
        ["品號", itemCodeSpan.textContent],
        ["品名", document.getElementById('productName').value],
        ["規格", document.getElementById('spec').value],
        ["品類", catSel.options[catSel.selectedIndex].text],
        ["單位", (unitSel.value==='其他'?unitCustomInput.value:unitSel.value)],
        [""],
        ["品號必備", ""],
        ["品牌", brandSel.options[brandSel.selectedIndex].text],
        ["系列", seriesSel.value==='custom'?seriesCustomInput.value:seriesSel.options[seriesSel.selectedIndex].text],
        ["寵物", petSel.options[petSel.selectedIndex].text],
        ["流水號", pad(serialInput.value,3)],
        ...(isOutsourced
          ? [["販售國家語言", languageText], ["製造廠國家", manufactureText], ["直營/經銷", directText]]
          : [["主銷國家", countryText], ["直營/經銷", directText], ["經銷商編號", dealerVal]]),
        [""],
        ["ERP 必填區", ""],
        ["會計/分類", accountClassInput.value],
        ["主要庫別", "A01 製成品倉"],
        ["營收分類/品類", bankCatInput.value],
        ["銷售單位", salesUnitInput.value],
        ["有效天數", shelfLifeInput.value],
        ["複檢天數", recheckInput.value],
        ["品號屬性", "M 製成品倉"],
        ["低階碼", "99"],
        ["補貨政策", "L"],
        ["領料碼", "1"],
        [""],
        ["ERP 後補區", ""],
        ["條碼", document.getElementById('barcode').value],
        ["產品定價", document.getElementById('price').value]
      ];
      // 製作表
      const ws = XLSX.utils.aoa_to_sheet(data);
      // 樣式：標題加粗+底色，欄寬
      const titleRows = [0,7,16,28];
      for(let r of titleRows){
        if(!ws["A"+(r+1)]) continue;
        ws["A"+(r+1)].s = { font:{bold:true}, fill:{fgColor:{rgb:"F5F5F5"}}, alignment:{horizontal:"left"} };
        ws["B"+(r+1)] = {t:"s",v:"",s:{fill:{fgColor:{rgb:"F5F5F5"}}}};
      }
      // 內容欄寬
      ws['!cols'] = [{ wch: 18 }, { wch: 40 }];
      // 凍結
      ws['!freeze'] = {xSplit:1, ySplit:1};
      // 外框線條
      let maxR = data.length;
      for(let r=0;r<maxR;r++){
        let addrA = "A"+(r+1), addrB = "B"+(r+1);
        if(ws[addrA]) ws[addrA].s = Object.assign(ws[addrA].s||{}, {border:{bottom:{style:"thin",color:{rgb:"DDDDDD"}}}});
        if(ws[addrB]) ws[addrB].s = Object.assign(ws[addrB].s||{}, {border:{bottom:{style:"thin",color:{rgb:"DDDDDD"}}}});
      }
      // 組件
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "申請單");
      let filename = (itemCodeSpan.textContent!=="--"?itemCodeSpan.textContent:"itemcode") + ".xlsx";
      XLSX.writeFile(wb, filename);
    }

    // panel展開時，根據品類才展開配方/規格等
    function handleSerialCatSel(){
      const sectionMap = {
        feed: feedSection,
        tendon: tendonSection,
        snack: snackSection,
        kcdog: kcdogSection,
        canned: cannedSection
      };
      Object.entries(sectionMap).forEach(([key, section])=>{
        if(!section) return;
        section.style.display = serialCatSel.value===key ? 'block' : 'none';
      });
      if(serialCatSel.value==='canned' && cannedSerial){
        sanitizeCanned();
      }
      updateSerialValue();
    }
    // panel套用，寫回主表單流水號並高亮
    function applySerialToForm(){
      updateSerialValue();
      serialInput.value = pad(serialInput.value,3);
      serialInput.focus();
      serialInput.style.background="#fffae6";
      setTimeout(()=>serialInput.style.background="",800);
      serialTip.textContent = "流水號已套用！";
      setTimeout(()=>{ serialTip.textContent=""; }, 1600);
      document.getElementById('serialGen').open = false;
    }
    // 綁定事件
    productTypeRadios.forEach(r=>r.addEventListener('change', handleProductTypeChange));
    catSel.addEventListener('change', populateUnits);
    unitSel.addEventListener('change', handleUnitChange);
    unitCustomInput.addEventListener('input', handleUnitChange);
    brandSel.addEventListener('change', refreshSeries);
    seriesSel.addEventListener('change', ()=>seriesCustomWrap.style.display = seriesSel.value==='custom'?'flex':'none');
    document.querySelectorAll('input[name="direct"]').forEach(r=>r.addEventListener('change', ()=>{
      const selectedType = document.querySelector('input[name="productType"]:checked');
      const isOutsourced = selectedType && selectedType.value === 'outsourced';
      dealerWrap.style.display = !isOutsourced && r.value==='1' ? 'flex' : 'none';
    }));
    serialCatSel.addEventListener('change', handleSerialCatSel);
    [feedPrefix,feedSpec,tendonSize,tendonPack,snackPrefix,snackWeight,kcdogPrefix,kcdogWeight]
      .filter(Boolean)
      .forEach(e=>e.addEventListener('change', updateSerialValue));
    if(cannedSerial){
      cannedSerial.addEventListener('input', ()=>{
        sanitizeCanned();
        updateSerialValue();
      });
    }
    document.getElementById('applySerialBtn').addEventListener('click', applySerialToForm);
    document.getElementById('generateBtn').addEventListener('click', generateCode);
    document.getElementById('exportBtn').addEventListener('click', exportToExcel);

    // 初始化
    handleProductTypeChange();
    populateUnits();
    handleUnitChange();
    refreshSeries();
    initSerial();
    updateSerialValue();
    // 預設panel隱藏下方區塊
    [feedSection,tendonSection,snackSection,kcdogSection,cannedSection].forEach(section=>{
      if(section) section.style.display = 'none';
    });
    // panel展開/收合時自動聚焦品類
    document.getElementById('serialGen').addEventListener('toggle', e=>{
      if(e.target.open) serialCatSel.focus();
    });
  })();
  </script>
</body>
</html>
